# 入退室管理システムの停止ならびに削除方法

この文書では入退室管理システムの停止方法ならびに削除方法について記載します

各々のリポジトリにはない情報なので注意してください

オプションと書かれた節は必要ならば読んでください


## 0. 前提

- この文書はITSで稼働中のラズパイについて書かれたものです
- 上から順に読んでいくと入退室管理システムをラズパイから取り除くことができるように構成しました(完全に導入前の状態に戻すことはできません)
- 入退室管理システムは [pm2](https://github.com/Unitech/pm2) によってプロセスを管理されています
  - 基本的には pm2 のコマンドを使ってコントロールします
- 作業を始める前に pi ユーザでログインしていることを確認してください

  ```bash
  whoami
  ```
- ここでいう**停止**とは OS の起動後にアプリが自動起動するのを停止することを指します
- ここでいう**削除**とはアプリを pm2 の管理対象から外すことを指します

## 1. 停止

現在 pm2 によって管理されているアプリの一覧を確認してください

status 欄が active になっているものが現在稼働中のアプリです

ams-frontend、ams-backend、rdr-bridge、bou-responder の4つが稼働していると思います。

```bash
pm2 ls # list や status でも同様
```

4つのシステムが稼働していますが、全て停止するには次のコマンドを実行してください

```bash
pm2 stop all # pm2 が管理している全システムを一時停止
pm2 save # 変更を保存する
```

個別に止めたい場合は all ではなく `{各アプリの name}` を指定してください(bou-responder の例: `pm2 stop bou-responder`)

なお `{各アプリの name}` は、前述の `pm2 ls` から確認できます

## 削除

削除も停止と同様です

```bash
pm2 delete all # 自動起動オフ
pm2 save # 変更を保存する
```

## pm2 自体の停止

pm2 自体は systemd のサービスとして起動しています(systemd スタート -> pm2 スタート -> 入退室管理システムスタート の流れ)

入退室管理システムをこれ以上使用しない場合は pm2 自体も不要になるかと思いますので、以下の手順に沿って pm2 自体を systemd サービスから削除してください

1. コマンドの確認
    
    ```bash
    pm2 unstartup # systemd のサービスから外すためのコマンドが表示される
    ```

2. コマンドの実行

    1で表示されたコマンドを端末にコピペして実行する

> systemd の設定に手を加えるには root 権限が必要なのでこのように少々遠回りな手順になっています

## 【オプション】データベースの削除

入退室管理システムではデータベースとして MySQL を使用しています

ログを残す役目を果たしたらデータベースも削除してしまって良いと思います

|データベース名|ams|
|---|---|

以下のコマンドでデータベースが消えます

戻せないので注意してください

```bash
sudo mysql -uroot -p -e 'DROP DATABASE AMS;'
# パスワード入力を求められるので入れる(0000とかそんな感じ)
```

ログが必要な場合はあらかじめ ams-frontend の CSV 書き出し機能を使うかバックアップ系のコマンド(mysqldump 等)やソフトを使って抜き出しておいてください

## 【オプション】ソースコードの削除

ここまでの手順で、システムは起動しなくなりましたがソースコード等も削除したい場合は `ams-project/` ディレクトリを削除してください

ただし、ams-backend ディレクトリにある`config.yml` というファイルには MySQL のユーザ名とパスワードが書いてあることに注意してください

権限が不足している都合上、データベースを削除するような時には使えませんが、もしかしたら何かで使うかもしれないのでデータベースを削除するまでは、上記のファイルは残しておくことをおすすめします

```bash
rm -rf /home/pi/ams-project # 全て削除
```

3つのシステムのソースコードは `ams-project/` 以下にそれぞれ入っていますので個別に削除する場合は個別に削除してください

```bash
rm -rf /home/pi/ams-project/bou-responder # bou-responder のみ削除
```
